{{- $fingerprint := .Scratch.Get "fingerprint" -}}
{{- $autoTranslate := .Site.Params.autoTranslate -}}
{{- $languages := site.Store.Get "languages" -}}

{{- if $autoTranslate.enable -}}
  {{- /* translate.js */ -}}
  {{- dict "Source" "lib/translate.js" "Fingerprint" $fingerprint "Defer" true "Minify" hugo.IsProduction | dict "Scratch" .Scratch "Data" | partial "scratch/script.html" -}}

  {{- /* Config script */ -}}
  {{- $hugoLangCodes := slice -}}
  {{- $hugoLangMap := dict -}}
  {{- range .AllTranslations }}
    {{- $hugoLangCodes = $hugoLangCodes | append .Language.LanguageCode -}}
    {{- $hugoLangMap = $hugoLangMap | merge (dict .Language.LanguageCode .RelPermalink) -}}
  {{- end -}}
  {{- $config := dict "hugoLangCodes" $hugoLangCodes "hugoLangMap" $hugoLangMap -}}
  {{- with .Params.local -}}
    {{- $config = dict "local" . | merge $config -}}
  {{- end -}}
  {{- $configJS := $config | jsonify | printf "window.ATConfig=%s;" -}}
  {{- if hugo.IsServer -}}
    {{- $configJS = add $configJS "console.log('Auto Translate config:', window.ATConfig);" -}}
  {{- end -}}
  {{- $configJS | dict "Content" | dict "Scratch" .Scratch "Data" | partial "scratch/script.html" -}}

  {{- /* cmpt-translate.js */ -}}
  {{- $options := dict "targetPath" "js/cmpt-translate.min.js" "minify" hugo.IsProduction -}}
  {{- $params := dict
    "service" ($autoTranslate.service | default "client.edge")
    "languages" ($autoTranslate.languages | default slice)
    "ignoreID" ($autoTranslate.ignoreID | default slice)
    "ignoreClass" ($autoTranslate.ignoreClass | default slice)
    "ignoreTag" ($autoTranslate.ignoreTag | default slice)
    "detectLocalLanguage" ($autoTranslate.detectLocalLanguage | default false)
    "supportLanguages" ($languages | default slice)
  -}}
  {{- $options = dict "params" $params | merge $options -}}
  {{- if not hugo.IsProduction -}}
    {{- $options = dict "sourceMap" "inline" | merge $options -}}
  {{- end -}}
  {{- dict "Source" "js/cmpt-translate.js" "Build" $options "Fingerprint" $fingerprint "Defer" true | dict "Scratch" .Scratch "Data" | partial "scratch/script.html" -}}
{{- end -}}
